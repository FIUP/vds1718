\newcommand{\Sds}{\dsCtxt{s}}
\newcommand{\mineq}{\sqsubseteq}

\exercise{Esercizio 9}
{
	Prove or disprove the following semantic equivalence:
	\begin{center}
	$\wbS{b}{S}\eqDS{}\wbS{b}{(\concat{$S$}{$\ifABC{b}{S}{\skipistr}$})}$
	\end{center}
	where $b \in{} \bexp{}$ and $S \in{} \stm{}$
}
{
	Per dimostrare che vale:
	\begin{center}
	$\wbS{b}{S}\eqDS{}\wbS{b}{(\concat{$S$}{$\ifABC{b}{S}{\skipistr}$})}$
	\end{center}
	Devo dimostrare che:
	\begin{center}
	$\dsCtxt{\wbS{b}{S}}=
	\dsCtxt{\wbS{b}{(\concat{$S$}{$\ifABC{b}{S}{\skipistr}$})}}$
	\end{center}
	Dove:
	\begin{center}
	$\dsCtxt{\wbS{b}{S}}=\fixp{F}$ con 
	$F~g~=~\cond{b}{g \circ{} \Sds{}}{\idDS}$ \\
	\end{center}
	e
	\begin{center}
	$\dsCtxt{\wbS{b}{(\concat{$S$}{$\ifABC{b}{S}{\skipistr}$})}}=
	\fixp{G}$ con \\
	$G~g~=~\cond{b}{g \circ{} \dsCtxt{\concat{$S$}
	{$\ifABC{b}{S}{\skipistr}$}}}{\idDS}~=~$ \\
	$=~\cond{b}{g \circ{} \dsCtxt{\ifABC{b}{S}{\skipistr}} \circ{} }
	{\idDS}~=$ \\
	$=~\cond{b}{g \circ{} \cond{b}{\Sds{}}{\skipistr} \circ{} \Sds{}}{\idDS}$
	\end{center}
	Quindi devo dimostare che vale:
	\begin{center}
	$\fixp{F}~=~\fixp{G}$
	\end{center}
	Per fare ciò posso dimostrare separatamente le due seguenti affermazioni:
	\begin{enumerate}
	\item $\fixp{F}~\mineq~\fixp{G}$
	\item $\fixp{G}~\mineq~\fixp{F}$
	\end{enumerate}

	\textbf{Prima parte $\fixp{G}~\mineq~\fixp{F}$}\\
	Per dimostrare che vale $\fixp{G}~\mineq~\fixp{F}$ utilizzo il
	\textbf{Fixed point induction lemma} che afferma che, date $f$ e $d$:
	\begin{center}
	se $fd~\mineq~d~\Longrightarrow~\fixp{f}~\mineq~d$
	\end{center}
	istanziato con:
	\begin{center}
	$f~=~G$ \\
	$d~=~\fixp{F}$
	\end{center}
	Quindi:
	\begin{center}
	se $G(\fixp{F})~\mineq~\fixp{F}~\Longrightarrow~\fixp{G}~\mineq~\fixp{F}$
	\end{center}
	Sviluppo quindi $G(\fixp{F})$:
	\begin{center}
	$G(\fixp{F})~=~\cond{b}{\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{}}{\idDS}$
	\end{center}
	Quindi dato uno stato $s$ si hanno due casi a seconda della valutazione della guardia b in $s$:
	\begin{itemize}
		\item \caso{\evalBbs{b}{s}=ff}: In questo caso si ha:
		\begin{center}
		$(\cond{b}{\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{}}{\idDS})s~=~(\idDS{})s~=~s$
		\end{center}
		Ma quindi:
		\begin{center}
		$(\fixp{F})s~=~(F(\fixp{F}))s~=~(\cond{b}{\fixp{F} \circ{} \Sds{}}{\idDS})s~=$\\$=~(\idDS{})s~=~s$
		\end{center}
		Ottenendo difatto lo stesso stato.

		\item \caso{\evalBbs{b}{s}=tt}: In questo caso si ha:
		\begin{center}
		$(\cond{b}{\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{}}{\idDS})s~=$\\$=~(\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{})s$
		\end{center}
		Abbiamo quindi due sottocasi a seconda della valutazione di $(\Sds{})s$:
		\begin{itemize}
			\item \caso{\Sds{}_s~=~undef}: in questo caso poichè ho:
			\begin{center}
			$(\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{})s$
			\end{center}
			Allora tutto verrà valutato in $undef$ poichè la composizione di $undef$ con qualsiasi cosa restituisce sempre $undef$.\\
			Dall'altra parte quindi troviamo:
			\begin{center}
			$(\fixp{F})s~=~(F(\fixp{F}))s~=~(\cond{b}{\fixp{F} \circ{} \Sds{}}{\idDS})s~=~(\fixp{F} \circ{} \Sds{})s~=~undef$
			\end{center}
			Poichè assumiamo: (i) $\evalBbs{b}{s}=tt$ e (ii) $\Sds{}_s~=~undef$

			\item \caso{\Sds{}_s~=~s'}: In questo caso si ha:
			\begin{center}
			$(\fixp{F} \circ \cond{b}{\Sds{}}{\idDS} \circ{} \Sds{})s~=~
			(\fixp{F} \circ \cond{b}{\Sds{}}{\idDS})s'$
			\end{center}
			che a seconda della valutazione di $b$ in $s'$ evolverà in:
			\begin{itemize}
			\item $(\fixp{F} \circ \Sds{})s'$ se $\evalBbs{b}{s'}=tt$
			\item $(\fixp{F} \circ \idDS)s'~=~(\fixp{F})s'~=~(F(\fixp{F}))s'~=~(\cond{b}{\fixp{F} \circ{} \Sds{}}{\idDS})s'~=~(\idDS{})s'~=~s'$ se $\evalBbs{b}{s'}=ff$
			\end{itemize}
			Dall'altra parte quindi troviamo:
			\begin{center}
			$(\fixp{F})s~=~(F(\fixp{F}))s~=~(\cond{b}{\fixp{F} \circ{} \Sds{}}{\idDS})s~=~(\fixp{F} \circ{} \Sds{})s~=~(\fixp{F})s'~=~(F(\fixp{F}))s'~=~(\cond{b}{\fixp{F} \circ{} \Sds{}}{\idDS})s'$
			\end{center}
			Che come nel caso precedente evolverà in:
			\begin{itemize}
			\item $(\fixp{F} \circ \Sds{})s'$ se $\evalBbs{b}{s'}=tt$
			\item $(\idDS{})s'~=~s'$ se $\evalBbs{b}{s'}=ff$
			\end{itemize}
		\end{itemize}
		
		
	\end{itemize}
	\dsCtxt{A}
	\fixp{A}
	\FPIL{}
	\idDS{}
	\undefDS{}
	$\cond{A}{B}{C}$
	\setRel{A}{B}
}
